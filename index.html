<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="format-detection" content="telephone=no, address=no, email=no">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>초대</title>
  <style>
    @font-face { font-family: "Chodae"; src: url("chodae.otf") format("opentype"); font-display: swap; }
    html, body, * { font-family: "Chodae", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important; }

    :root{ --bg:#ffffff; --fg:#000000; --pink:#E85398; }
    body.dark { --bg:#000000; --fg:#ffffff; }
    body.pink { --bg:#ffffff; --fg:var(--pink); }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0;}
    body{ background:var(--bg); color:var(--fg); display:flex; flex-direction:column; align-items:center; justify-content:center; }

    .notice{ text-align:center; opacity:.85; font-size:22px; margin:0 0 45px 0; }

    .stage{ display:flex; justify-content:center; align-items:center; width:100%; min-height:66vh; position:relative; }
    #text{
      width:90%; max-width:1400px;
      height:100%; outline:none; border:none; background:transparent; color:var(--fg);
      font-size:72px; line-height:1.3;
      resize:none; overflow:auto; text-align:left; padding-left:30px;
      position:absolute; top:0;
      caret-color: var(--fg);
      -webkit-user-modify: read-write-plaintext-only;
    }
    #text::placeholder { color:#dddddd; opacity:0.9; }

    .controls{ margin-top:40px; display:flex; gap:28px; justify-content:center; align-items:center; flex-wrap:wrap; padding:10px 14px; }
    .ctrl{ display:flex; align-items:center; gap:24px; }
    .label{ font-size:24px; }

    button{
      padding: 6px 12px 9px 12px;
      border:1.2px solid #aaa;
      background:#fff;
      color:#000;
      cursor:pointer;
      border-radius:10px;
      transition: background-color .15s ease, box-shadow .15s ease;
    }
    button:disabled{ opacity:.6; cursor:default; }

    #archiveDlg button{ padding: 4px 9px 6.5px 9px; font-size: 15px; border-radius:7px; }

    body.dark button{
      background:rgba(255,255,255,.06);
      color:#fff;
      border-color:rgba(255,255,255,.28);
    }

    #saveEntry, #openArchive { font-size:18px; border: 1px solid; }

    /* range */
    input[type=range]{ -webkit-appearance:none; appearance:none; width:320px; background:transparent; }
    input[type=range]::-webkit-slider-runnable-track{ height:1.5px; background:var(--fg); border:none; }
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%;
      background:var(--bg); border:1px solid var(--fg); margin-top:calc((1.5px - 18px)/2);
    }

    input[type=radio]{ display:none; }
    .dot{ width:18px; height:18px; border-radius:50%; display:inline-block; border:none; vertical-align:middle; cursor:pointer; }
    #mode-dark + label .dot{ background:#000; }
    #mode-pink + label .dot{ background:#E85398; }
    input[type=radio]:checked + label .dot{ outline:2px solid currentColor; outline-offset:2px; }

    .ctrl:nth-child(3) { gap:8px; }
    .ctrl:nth-child(3) label { margin-left:11px; margin-right:6px; }

    dialog#archiveDlg{
      width:min(900px,90vw);
      border:none; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.15);
      overflow:hidden;
      background:var(--bg); color:var(--fg);
      padding:16px 24px 20px;
    }
    body.dark dialog#archiveDlg{
      background:rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.32);
    }
    dialog#archiveDlg::backdrop{ background:rgba(0,0,0,.35); }

    body.pink button{ background:#fff; color:var(--pink); border-color:var(--pink); }
    body.pink #archiveDlg button{ color:var(--pink); border-color:var(--pink); background:#fff; }

    body.pink input[type=range]::-webkit-slider-runnable-track{ background:var(--pink); }
    body.pink input[type=range]::-webkit-slider-thumb{ border-color:var(--pink); background:#fff; }
    body.pink input[type=range]::-moz-range-track{ background:var(--pink); height:1.5px; }
    body.pink input[type=range]::-moz-range-thumb{ border:1px solid var(--pink); background:#fff; width:18px; height:18px; border-radius:50%; }

    body.pink dialog#archiveDlg{ border:1px solid rgba(232,83,152,.25); }
    body.pink .entry{ border-color:rgba(232,83,152,.25); background:rgba(232,83,152,.03); }

    .dlg-head{
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid #eee; position:sticky; top:0; background:transparent;
      color:var(--fg); padding:12px 0;
    }
    body.dark .dlg-head{ border-bottom-color: rgba(255,255,255,.18); }
    .dlg-head .actions{ justify-self:end; transform: translateX(-12px);}

    .dlg-body{padding:16px 0; display:grid; gap:16px; max-height:60vh; overflow:auto;}

    .entry{
      border:1px solid #e5e5e5; border-radius:10px; padding:18px;
      background:rgba(0,0,0,0.02); font-size:48px; line-height:1.35;
    }
    body.dark .entry{
      border-color: rgba(255,255,255,.32);
      background: rgba(255,255,255,.08);
    }

    .entry .head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .entry time{ display:block; font-size:18px; opacity:.6; margin:0; }
    .entry .btns{ justify-self:end; display:flex; gap:8px; margin:0; transform: translateX(7px) }

    .entry textarea.editbox{
      width:100%; font:inherit; line-height:inherit; color:inherit; background:transparent;
      border:1px dashed currentColor; border-radius:8px; padding:10px 12px; resize:vertical;
      min-height:3.6em; white-space:pre-wrap;
    }
    .entry .inline-actions{ display:flex; gap:8px; margin-top:10px; }

    .entry[data-editing="1"] [data-edit]{ display:none; }

    @media (max-width:720px){
      #text{ font-size:42px; }
      input[type=range]{ width:200px; }
      .label{ font-size:20px; }
      .entry{ font-size:32px; }
    }
  </style>
</head>

<body>
  <div class="notice">한글 전용 서체로써 영어는 사용이 불가능합니다</div>

  <main class="stage">
    <textarea id="text" placeholder="한글을 자유롭게 작성해 보세요" spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off" lang="ko"></textarea>
  </main>

  <footer class="controls" aria-label="Controls">
    <div class="ctrl"><span class="label">크기</span><input id="size" type="range" min="20" max="200" step="1" value="72" /></div>
    <div class="ctrl"><span class="label">행간</span><input id="lh" type="range" min="0.9" max="2.0" step="0.01" value="1.30" /></div>
    <div class="ctrl">
      <span class="label">색상</span>
      <input type="radio" name="mode" id="mode-dark" />
      <label for="mode-dark" title="검정 배경, 흰 글자"><span class="dot"></span></label>
      <input type="radio" name="mode" id="mode-pink" />
      <label for="mode-pink" title="흰 배경, 핑크 글자"><span class="dot"></span></label>
    </div>
    <div class="ctrl">
      <button id="saveEntry" type="button">방명록 쓰기</button>
      <button id="openArchive" type="button">방명록 열기</button>
    </div>
  </footer>

  <dialog id="archiveDlg">
    <div class="dlg-head">
      <strong style="font-size:30px; padding-left: 15px;">방명록</strong>
      <div class="actions"><button id="closeArchive" type="button">닫기</button></div>
    </div>
    <div id="archiveList" class="dlg-body"></div>
  </dialog>

<script type="module">
  /* ---------- UI 유틸 ---------- */
  const $ = (s, el=document)=>el.querySelector(s);
  const text=$('#text'), size=$('#size'), lh=$('#lh'), stage=document.querySelector('.stage');
  function apply(){ text.style.fontSize=size.value+'px'; text.style.lineHeight=lh.value; }
  function enforceLayout(){
    const fs=parseFloat(size.value), lhVal=parseFloat(lh.value);
    const linePx=fs*lhVal, neededPx=Math.ceil(linePx*3+24), twoThirdPx=Math.floor(window.innerHeight*0.66);
    stage.style.minHeight=Math.max(neededPx, twoThirdPx)+'px';
  }
  size.addEventListener('input', ()=>{ apply(); enforceLayout(); });
  lh.addEventListener('input',  ()=>{ apply(); enforceLayout(); });
  window.addEventListener('resize', enforceLayout);
  apply(); enforceLayout();

  const modeDark=$('#mode-dark'), modePink=$('#mode-pink');
  const MODE_KEY='chodae_mode';
  function setMode(){
    document.body.classList.remove('dark','pink');
    if(modeDark.checked) document.body.classList.add('dark');
    else if(modePink.checked) document.body.classList.add('pink');
    try{ localStorage.setItem(MODE_KEY, modeDark.checked?'dark':modePink.checked?'pink':'light'); }catch{}
  }
  modeDark.addEventListener('change', setMode);
  modePink.addEventListener('change', setMode);
  document.querySelectorAll('label[for^="mode-"]').forEach(l=>{
    l.addEventListener('click', ()=>{ const id=l.getAttribute('for'); const i=document.getElementById(id); if(i){ i.checked=true; setMode(); }});
    l.addEventListener('dblclick', ()=>{ modeDark.checked=false; modePink.checked=false; setMode(); });
  });
  (function(){ let saved=null; try{ saved=localStorage.getItem(MODE_KEY);}catch{} if(saved==='dark') modeDark.checked=true; else if(saved==='pink') modePink.checked=true; setMode(); })();

  /* ---------- Firebase (CDN ESM) ---------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, query, orderBy, onSnapshot, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAF_vabMMbJnIkkrmhdSwiqtSuUiACUbjw",
    authDomain: "chodae-1050a.firebaseapp.com",
    projectId: "chodae-1050a",
    storageBucket: "chodae-1050a.appspot.com",
    messagingSenderId: "34338602497",
    appId: "1:34338602497:web:12e066146c6a089aae4a00"
  };

  const app = initializeApp(firebaseConfig);

  const auth = getAuth(app);
  let db, colRef, unsub=null;
  const dlg=$('#archiveDlg'), listEl=$('#archiveList');
  const saveBtnEl = $('#saveEntry');

  // 초기: 클릭 안내 및 비활성화
  function preInitHandler(e){
    e.preventDefault();
    alert('초기화 중입니다. 잠시 후 다시 시도해 주세요.');
  }
  saveBtnEl.disabled = true;
  saveBtnEl.addEventListener('click', preInitHandler);

  let handlersBound = false;

  onAuthStateChanged(auth, async (user)=>{
    try{
      if(!user){ await signInAnonymously(auth); return; }
      db = getFirestore(app);
      try{ await enableIndexedDbPersistence(db); }catch(e){ /* 사파리 비공개 모드 등은 무시 */ }
      colRef = collection(db, "chodae");

      // 준비 완료: 실제 핸들러 연결
      if(!handlersBound){
        saveBtnEl.removeEventListener('click', preInitHandler);
        saveBtnEl.disabled = false;
        bindHandlers();
        handlersBound = true;
      }
    }catch(e){
      alert('인증 오류: ' + (e?.message || e));
      console.error(e);
    }
  });

  function cardHTML(e){
    const whenStr = (ts)=>{ try{ const d=new Date(ts); return d.toLocaleString(); }catch{return ''} };
    const esc = (s)=>String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    return `<article class="entry" data-id="${e.id}">
      <div class="head">
        <time>${whenStr(e.ts)}</time>
        <div class="btns"><button type="button" data-edit="${e.id}">수정</button></div>
      </div>
      <div class="content" style="white-space:pre-wrap;">${esc(e.text)}</div>
    </article>`;
  }

  function bindHandlers(){
    // 저장
    saveBtnEl.addEventListener('click', async ()=>{
      const val=(text.value||'').trim();
      if(!val){ alert('방명록을 작성해 주세요.'); return; }
      try{
        await addDoc(colRef, { text: val, ts: serverTimestamp(), uid: auth.currentUser?.uid||null });
        text.value='';
        alert('방명록이 작성되었습니다. 좋은 하루 되세요.');
      }catch(e){
        alert('저장 실패: ' + (e?.message||e));
        console.error(e);
      }
    });

    // 목록(실시간)
    $('#openArchive').addEventListener('click', ()=>{
      const qy=query(colRef, orderBy('ts','desc'));
      unsub = onSnapshot(qy, snap=>{
        const items=snap.docs.map(d=>{
          const data=d.data(); const ts=data.ts?.toMillis?data.ts.toMillis():data.ts||Date.now();
          return { id:d.id, text:String(data.text||''), ts };
        });
        listEl.innerHTML = items.length ? items.map(cardHTML).join('') : '<div style="opacity:.7">저장된 항목이 없습니다.</div>';
        listEl.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> startInlineEdit(b.getAttribute('data-edit')) ));
      }, err=>{
        listEl.innerHTML='<div style="opacity:.7">목록을 불러오지 못했습니다.</div>';
        console.error(err);
      });
      dlg.showModal();
    });

    $('#closeArchive').addEventListener('click', ()=>{ if(unsub){unsub();unsub=null;} dlg.close(); });
  }

  // 인라인 수정
  async function startInlineEdit(id){
    const article = listEl.querySelector(`article[data-id="${id}"]`);
    if(!article || article.querySelector('textarea.editbox')) return;
    const contentDiv = article.querySelector('.content');
    const original = contentDiv.textContent||'';

    article.setAttribute('data-editing','1');
    const ta=document.createElement('textarea'); ta.className='editbox'; ta.value=original;
    requestAnimationFrame(()=>{ ta.style.height='auto'; ta.style.height=(ta.scrollHeight+2)+'px'; });
    ta.addEventListener('input', ()=>{ ta.style.height='auto'; ta.style.height=(ta.scrollHeight+2)+'px'; });

    const actions=document.createElement('div'); actions.className='inline-actions';
    const saveBtn=document.createElement('button'); saveBtn.textContent='저장';
    const cancelBtn=document.createElement('button'); cancelBtn.textContent='취소';
    actions.appendChild(saveBtn); actions.appendChild(cancelBtn);

    contentDiv.style.display='none';
    contentDiv.insertAdjacentElement('afterend', ta);
    ta.insertAdjacentElement('afterend', actions);
    ta.focus(); ta.setSelectionRange(ta.value.length, ta.value.length);

    function restore(){ article.removeAttribute('data-editing'); ta.remove(); actions.remove(); contentDiv.style.display=''; }
    ta.addEventListener('keydown',(e)=>{ if((e.metaKey||e.ctrlKey)&&e.key==='Enter'){ e.preventDefault(); saveBtn.click(); } else if(e.key==='Escape'){ e.preventDefault(); cancelBtn.click(); }});
    cancelBtn.addEventListener('click', restore);

    saveBtn.addEventListener('click', async ()=>{
      const v=(ta.value||'').trim(); if(!v){ alert('빈 내용은 저장할 수 없습니다.'); return; }
      try{
        await updateDoc(doc(db,'chodae',id), { text:v, ts: serverTimestamp() });
        contentDiv.textContent=v;
        const tEl=article.querySelector('time'); if(tEl){ tEl.textContent=(new Date()).toLocaleString(); }
        restore();
      }catch(e){
        alert('수정 실패: ' + (e?.message||e));
        console.error(e);
      }
    });
  }
</script>

</body>
</html>
